**본 프로그램 사용과 관련하여 발생하는 문제의 모든 책임은 사용자 본인에게 있습니다.**

### 소개

이 프로그램은 이베스트증권과 키움증권의 API 사용을 더욱 편리하게 제공하기 위해 개발되었습니다. 기본적으로는 주식 거래에 필요한 신규주문, 주문정정, 주문취소 기능을 구현하였습니다. 이러한 명령은 텔레그램이나 TCP 소켓을 통해 정해진 형식으로 전송할 수 있습니다.

투자 알고리즘은 사용자가 직접 개발하고 이를 프로그램에 적용해야 합니다. 투자 알고리즘의 개발은 증권사에서 제공하는 검색식 기능을 활용하거나 AI 툴(텐서플로우나 파이토치 등)을 이용하여 수행할 수 있습니다. 특히, 본 프로그램은 투자 알고리즘과 독립적으로 실행할 수 있는 환경을 제공합니다.

이 프로그램을 사용하려면 다음과 같은 준비가 필요합니다.

- **이베스트증권 또는 키움증권의 계좌**
- **API 사용에 대한 기본적인 지식**

예제 프로그램은 소켓 통신으로 서버에 명령을 전달할 수 있습니다. 사용자는 예제 프로그램으로 서버 프로그램의 기본적인 동작을 확인하고 통신 방법을 이해할 수 있습니다. 이를 참고하여 실제 사용자 본인이 개발한 알고리즘과 연동할 수 있는 방법에 대한 이해를 높일 수 있습니다.

### 설치 프로그램

- python 3.10 이상의 버전.
    - 이 프로그램은 python 3.10 버전에서 작성되었습니다.
	- 64bit 사용 불가.
	    - 이 프로그램은 python 32bit 버전에서만 실행할 수 있습니다. python 64bit 버전에서는 실행할 수 없습니다.
- 텔레그램
    - 이 프로그램은 텔레그램을 사용하여 명령을 전송할 수 있습니다. 따라서 텔레그램을 설치해야 합니다.
	- [텔레그램 가입과 봇 생성](https://wikidocs.net/91962) 을 참고하기 바랍니다.
	    - 텔레그램 봇을 생성하여 이 프로그램과 연결해야 합니다. 이때 받은 ID와 토큰은 별도로 잘 보관하여야 합니다.
- 사용할 증권사의 API 프로그램
    - 이 프로그램은 이베스트증권과 키움증권의 API를 사용하여 주식 주문을 실행할 수 있습니다. 따라서 사용할 증권사의 API 프로그램을 설치해야 합니다.
    - 이베스트의 경우 OPEN API 가 아니라 **xingAPI** 를 설치해야 합니다.

### 프로젝트 복사 순서

1. **git clone 명령**    
    - git clone 명령은 GitHub에서 저장소를 복사하는 명령입니다.
    - 다음과 같이 git clone 명령을 실행하면 GitHub에서 `ebest_kiwoom_stock` 저장소를 현재 작업 디렉토리에 복사합니다.
    
    ```
    git clone https://github.com/dugbang/ebest_kiwoom_stock
    ```
    
2. **가상 환경 생성**    
    - 가상 환경은 프로그램을 실행하기 위한 별도의 환경을 제공합니다.
    - 가상 환경을 사용하면 프로그램에 필요한 패키지만 설치하고 사용할 수 있습니다.
    - 가상 환경을 생성하려면 다음과 같이 python -m venv 명령을 실행합니다.
    
    ```
    python -m venv ./venv
    ```
    
    - 이 명령은 현재 작업 디렉토리에 `venv`라는 이름의 가상 환경을 생성합니다.
3. **가상 환경 활성화**    
    - 가상 환경을 활성화하면 가상 환경의 패키지만 사용할 수 있습니다.
    - 가상 환경을 활성화하려면 다음과 같이 `./venv/Scripts/activate` 명령을 실행합니다.
    
    ```
    ./venv/Scripts/activate
    ```
    
4. **필수 패키지**    
    - 프로그램 실행에 필요한 패키지를 설치합니다.
    - 다음과 같이 pip install 명령을 실행하여 필수 패키지를 설치합니다.
    
    ```
    pip install pypiwin32 pyqt5 python-telegram-bot==13.15 pyyaml
    ```
    
    - 이 명령은 `pypwin32`, `pyqt5`, `python-telegram-bot==13.15`, `pyyaml` 패키지를 설치합니다.

#### 초보자를 위한 팁

- git clone 명령을 실행할 때는 작업 디렉토리로 이동한 후 실행해야 합니다.
- 가상 환경을 생성할 때는 가상 환경의 이름을 지정할 수 있습니다.
- 가상 환경을 활성화할 때는 `./venv/Scripts/activate` 명령을 실행한 후 `exit` 명령을 실행하여 가상 환경을 비활성화해야 합니다.
- 필수 패키지를 설치할 때는 패키지 이름을 정확하게 입력해야 합니다.


### 환경 설정

이 프로그램의 환경설정은 사용자가 이베스트 증권이나 키움 증권을 사용하는 경우를 기준으로 합니다. 설정은 각 증권사별로 `ebest` 또는 `kiwoom` 디렉토리에서 수행됩니다.

1. **기본 설정 파일 수정**

- `ebest/cfg/configuration.yaml` 또는 `kiwoom/cfg/configuration.yaml` 파일을 엽니다.
- 대부분의 경우, 기본값을 그대로 사용할 수 있습니다.
- 키움 증권 사용자의 경우, `login_dialog` 항목을 '0'으로 설정하면 로그인 창이 나타나지 않습니다.
```
# kiwoom ===========================================
login_dialog: 0 # 키움에서 로그인창을 띄울지 여부를 결정
```

2. **Telegram 봇 정보 설정**
- 동일한 경로에 `secret.yaml` 파일을 생성하고, 텔레그램 봇의 접속 정보를 입력합니다.
- [텔레그램 가입과 봇 생성](https://wikidocs.net/91962)을 참고하여 봇의 id와 token을 얻어옵니다.
```
telegram:
  id: xxxxxxx
  token: xxxxxxx:xxxxxxx
```

3. **이베스트 사용자 추가 설정**
- 이베스트 증권 사용자는 `secret.yaml` 파일에 추가적으로 로그인 정보를 입력해야 합니다.
- 서버 접속 정보, 로그인 ID, 비밀번호, 인증서 암호, 계좌 암호를 기입합니다.

```
# ===========================================================
login_info:
  server_address: ['hts.ebestsec.co.kr', 'demo.etrade.co.kr']
  id: ['user_id', 'user_id']  # login in
  pw: ['xxxx', 'xxxx']  # login password
  ppw: ['xxxx', '']     # 인증서 암호
  apw: ['xxxx', '0000'] # 계좌 암호
```

#### 초보자를 위한 팁

- `configuration.yaml` 파일은 기본적으로 제공되는 파일을 그대로 사용해도 됩니다.
- `secret.yaml` 파일은 사용자가 직접 생성해야 합니다.
- `secret.yaml` 파일에 입력하는 정보는 외부에 유출되지 않도록 각별히 유의해야 합니다.


### 텔레그램을 이용한 명령

텔레그램으로 프로그램을 제어할 수 있는 명령어는 다음과 같습니다.

**주문**

- **/o a_id [m/a/i] [sell/buy] code qty money/price**
    - 매매주문을 할 때 사용합니다.
    - `a_id`는 계좌 ID입니다.
    - `m`은 수동으로 입력값대로 주문 발생을 의미합니다.
    - `a`는 최우선 호가를 이용하여 price 가격을 결정합니다.
    - `i`는 최우선 호가 한단계 아래/위의 price 가격을 사용합니다. 바로 거래가 됩니다.
    - `a/i` 옵션의 경우 `qty` = 0이면 `money/price`을 기준으로 `qty`를 결정합니다.

예를 들어 다음과 같이 명령을 입력하면 000660 종목을 1000000원어치 빨리 매수합니다.

```
/o a_id i buy 000660 0 1000000
```

또는 다음과 같이 명령을 입력하면 000660 종목을 20주 최우선 호가로 매수합니다.

```
/o a_id a buy 000660 20
```

또는 다음과 같이 명령을 입력하면 000660 종목을 10주 135000원 매수 주문을 합니다.

```
/o a_id m buy 000660 10 135000
```

**주문정정 및 취소**

- **/m a_id [sell/buy] code qty price org_ord_no**
    - 주문을 정정할 때 사용합니다. `org_ord_no`는 `lm` 명령으로 확인할 수 있습니다.

예를 들어 다음과 같이 명령을 입력하면 a_id 계좌에 1234567890 주문번호로 발생한 주문을 000660 종목 10주 135000원 매수 주문으로 정정합니다.

```
/m a_id m buy 000660 10 135000 1234567890
```

- **/c a_id [sell/buy] code qty org_ord_no**
    - 주문을 취소할 때 사용합니다. `org_ord_no`는 `lm` 명령으로 확인할 수 있습니다.

예를 들어 다음과 같이 명령을 입력하면 a_id 계좌에 1234567890 주문번호로 발생한 주문을 000660 종목 10주 매수 주문을 취소합니다.

```
/c a_id m buy 000660 10 1234567890
```

**계좌확인**

- **/ls**    
    - 현재 연결된 계좌의 계좌 ID를 확인합니다.
- **/ls a_id**    
    - a_id 계좌에 보유한 주식종목을 확인합니다.
- **/lm a_id**    
    - a_id 계좌의 당일 거래내역을 확인합니다.

**프로그램 종료**
- **/shutdown**
    - 프로그램을 종료합니다.

#### 초보자를 위한 팁

- 명령을 입력할 때는 띄어쓰기를 잘 지켜야 합니다.
- 주문 시에는 `a_id`, `code`, `qty`는 반드시 입력해야 합니다.
- 주문정정 및 취소 시에는 `org_ord_no`는 반드시 입력해야 합니다.

텔레그램으로 프로그램을 제어하려면 먼저 `configuration.yaml` 파일에서 `telegram`의 `enable` 값을 `1`로 설정해야 합니다. 또한 `secret.yaml` 파일에 텔레그램 봇의 접속 아이디와 토큰을 저장해야 합니다.

### 프로그램 실행 방법

- exec 디레토리 아래 배치파일을 실행하면 됩니다.

1. ebest_trade.bat - ebest 접속 프로그램.
2. kiwoom_trade.bat - kiwoom 접속 프로그램.
3. sample.bat - GUI 샘플 프로그램. 텔레그램 없이 동작을 확인할 수 있습니다.
   - 추가적으로 개별적인 투자 알고리즘을 구현하는 경우 sample.py를 응용하여 실전에 적용할 수 있습니다.

### 참고자료

1. [파이썬으로 배우는 알고리즘 트레이딩](https://wikidocs.net/book/110)
2. [퀀트투자를 위한 키움증권 API](https://wikidocs.net/book/1173)
3. [키움 OpenAPI+ 파이썬 개발가이드](https://wikidocs.net/book/8107)

